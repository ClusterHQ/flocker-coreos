#!/opt/flocker/bin/python

# -*- coding: utf-8 -*-
import re
import sys

from flocker.node.script import AgentService, AgentServiceFactory, flocker_dataset_agent_main

"""
Grab the agent IP from the environment and monkey-patch the agent script
to use that IP rather than auto-detect
"""
FLOCKER_AGENT_IP = os.environ.get('FLOCKER_AGENT_IP')

if FLOCKER_AGENT_IP is None:
    sys.stderr.write("FLOCKER_AGENT_IP env variable required")
    exit(1)

def get_external_ip_from_env(self, host, port):
    return unicode(FLOCKER_AGENT_IP, "ascii")

AgentService.get_external_ip = get_external_ip_from_env
AgentServiceFactory.get_external_ip = get_external_ip_from_env

if __name__ == '__main__':
    sys.argv[0] = re.sub(r'(-script\.pyw|\.exe)?$', '', sys.argv[0])
    sys.exit(flocker_dataset_agent_main())